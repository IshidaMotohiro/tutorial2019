## ----setup, include=FALSE------------------------------------------------
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE, cache = TRUE, comment=NA)
library(tidyverse)
library(stringi)


## --------------------------------------------------------------
## library(RMeCab)
## df <-docDF("doc", type = 1)


## --------------------------------------------------------------
load("df.Rdata")


## ------------------------------------------------------------------------
head(df)


## --------------------------------------------------------------
## # どんな単語があるのか
## df$TERM


## --------------------------------------------------------------
df$TERM %>% head(20)


## ------------------------------------------------------------------------
df [ df$TERM=="理工" , ]


## ------------------------------------------------------------------------
df [ rowSums( df [, 
    c("文書1","文書2","文書3")]) > 5, ]


## --------------------------------------------------------------
## df$合計 <- rowSums(
##   df[, c("文書1", "文書2", "文書3") ] )


## --------------------------------------------------------------
df$合計 <- rowSums(
  df[, c("文書1", "文書2", "文書3") ] ) 
df %>% head() %>% select(TERM, 文書1, 文書2, 文書3, 合計)


## ------------------------------------------------------------------------
df$標準化 <- scale(df$合計)


## --------------------------------------------------------------
df %>% head() %>% select(TERM, 文書1, 文書2, 文書3,標準化)


## --------------------------------------------------------------
## install.packages("tidyverse")
## library(tidyverse)


## --------------------------------------------------------------
rm(df)
load("df.Rdata")


## --------------------------------------------------------------
df %>% select(TERM, POS1, 文書1, 文書2, 文書3) %>% head()


## --------------------------------------------------------------
tidy_df <- df %>% gather(key = Doc, value = FREQ, 
                         文書1, 文書2, 文書3) 
tidy_tib <- as_tibble(tidy_df) # この操作は必須ではない
tidy_tib %>% select(TERM, POS1, Doc, FREQ)


## ------------------------------------------------------------------------
tb <- tibble(
  Name = LETTERS[1:5],
  X = 1:5, 
  Y = X^2
)


## --------------------------------------------------------------
tb


## ------------------------------------------------------------------------
# 従来の方法
temp <- tb [ tb$Name=="B" , ]
max(temp $ Y)


## ------------------------------------------------------------------------
# 従来の方法 
max( tb [ tb$Name=="B", ] $ Y )


## ------------------------------------------------------------------------
# max(df2[df2$Name=="B",]$m)
tb %>% filter(Name == "B") %>% 
              select(Y) %>% max()


## ------------------------------------------------------------------------
# tidyverse
tb %>% select(Name, Y) %>% 
         arrange(desc(Name)) 


## ------------------------------------------------------------------------
mean(tb$X)


## ------------------------------------------------------------------------
tb %>% select(X) %>% mean()


## ------------------------------------------------------------------------
tb %>% select(X) %>% pull() %>% mean()


## ------------------------------------------------------------------------
# tidyverse
tb %>% filter(Y >= 5)


## ------------------------------------------------------------------------
# 従来の方法
temp <- tb
temp $ Y <- log(temp$Y)


## ------------------------------------------------------------------------
# tb2 <- tb
# tidyverse
tb %>% mutate(Y = log(Y)) 


## --------------------------------------------------------------
dat <- data.frame(Y = c("A", "A", "B", "B", "C", "C"), X1 = 2:7, X2 = 3:8)


## ------------------------------------------------------------------------
dat


## ------------------------------------------------------------------------
dat %>% mutate_if(is.numeric, log )


## ------------------------------------------------------------------------
dat %>% summarise(X1_mean = mean(X1), 
                  X1_sd = sd(X1))


## ------------------------------------------------------------------------
dat %>% summarise_if(is.numeric, mean)


## ------------------------------------------------------------------------
dat %>% summarise_if(is.numeric,
                     list(mean, var))


## ------------------------------------------------------------------------
dat %>% summarise_if(is.numeric, 
          list( ~mean(.), ~sd(.)))


## --------------------------------------------------------------
text <- "
Name|Time1|Time2|Time3
A|0.1|0.18|0.11
B|0.3|0.33|0.35
C|0.2|0.22|0.26
D|0.44|0.47|0.43
E|0.51|0.56|0.55
F|0.60|0.66|0.68
G|0.77|0.78|0.72
H|0.81|0.88|0.86
"
yoko <- read_delim (file = text, delim = "|")


## ------------------------------------------------------------------------
yoko 


## --------------------------------------------------------------
## yoko %>% gather(
##   key = time,
##   value = score,
##   -Name)


## --------------------------------------------------------------
yoko2 <-yoko %>% gather(
  key = time, 
  value = score, -Name)
yoko2


## --------------------------------------------------------------
## df %>% gather(key = year, value = n)


## --------------------------------------------------------------
df %>% head()


## ------------------------------------------------------------------------
library(tidyverse)
tidy_df <- df %>% gather(
          key = Doc, value = FREQ,
          文書1, 文書2, 文書3) 


## ------------------------------------------------------------------------
tidy_df %>% filter(TERM == "。")


## --------------------------------------------------------------
## files <- list.files("C:\\kadai",
##                     pattern = "xlsx")


## ----eval = FALSE--------------------------------------------------------
## library(XLConnect)
## wb <- loadWorkbook(files[1])


## ------------------------------------------------------------------------
学生番号 <- stri_trans_nfkc_casefold(
 "１０１８０５１４５８石田基広.xlsx") %>%
     str_extract(
     "\\d{8,10}\\p{Han}*.xlsx$")


## --------------------------------------------------------------
学生番号


## ----eval =FALSE---------------------------------------------------------
## A11 <- getCellFormula(wb,
##            "Sheet1",
##            # 行番号と列番号
##            11, 1)


## --------------------------------------------------------------
## seiseki <- tibble(
##   Id =   {学生番号} ,
##   Name = {名前} ,
##   A11 =  {合計の式} ,
##   B11  = {平均値の式} ,
##   C11 = {標準偏差の式} )


## --------------------------------------------------------------
## seiseki <- seiseki %>%
##   mutate(
##     A11a = if_else(
##       A11 == "AVERAGE(A2:A10)",
##     1,  # 正答
##     0 ) # 誤答


## --------------------------------------------------------------
## seiseki <- seiseki %>%
##   mutate(A11a = A11 * 38,
##          B11a = B11 * 36,
##          C11a = C11 * 26,)


## --------------------------------------------------------------
## seiseki %>% mutate(
##   確定成績 =
##       rowSums(select_if(., is.numeric)))
## # seiseki %>% rowwise %>%
## #  mutate(確定成績=sum(A11a, B11a, C11a)) %>%
## #     select(学生番号, 名前, 確定成績)


## --------------------------------------------------------------
## genbo <- genbo %>%
##   left_join(seiseki,
##     by = "学生番号")


## ------------------------------------------------------------------------
stops <- tibble(
 TERM=c("、","。"))
stops 


## ------------------------------------------------------------------------
df %>% 
 anti_join(stops)    %>% head()


## --------------------------------------------------------------
## source("http://rmecab.jp/R/Rprofile.R")


## --------------------------------------------------------------
doc <- df %>% gather(key = Doc, 
  value = FREQ, 
  文書1, 文書2, 文書3) 


## ------------------------------------------------------------------------
p <- doc %>% 
  ggplot(aes(POS1,
             FREQ,
             fill=Doc)) +
  geom_bar(stat = 
             "identity")


## --------------------------------------------------------------
p


## --------------------------------------------------------------
library(gganimate)
library(gapminder)


## ----, ----------------------------------------------
## library(gganimate)
## p <- ggplot(
##   gapminder,
##   aes(x = gdpPercap, y=lifeExp, size = pop, colour = country)
##   ) +
##   geom_point(show.legend = FALSE, alpha = 0.7) +
##   scale_color_viridis_d() +
##   scale_size(range = c(2, 12)) +
##   scale_x_log10() +
##   labs(x = "GDP per capita", y = "Life expectancy")
## p + transition_time(year) +
##   labs(title = "Year: {frame_time}")


## --------------------------------------------------------------
yr <- gapminder %>%  select(-c(pop, gdpPercap)) %>% spread(key = year , value =  lifeExp)
yr


## ------------------------------------------------------------------------
gap <- gapminder %>%  
  filter(country %in% 
    c("Japan", "China", "Korea, Rep.")) 


## ------------------------------------------------------------------------
library(ggplot2)
p <- gap %>% 
  ggplot() 
#p<-ggplot(gap)


## --------------------------------------------------------------
p


## ------------------------------------------------------------------------
p <- p +
  aes(x =year, 
      y =lifeExp,
      size =pop,
      col =country)


## --------------------------------------------------------------
p


## --------------------------------------------------------------
## gap %>%
##   ggplot(aes(x = year, y = lifeExp,
##          size = pop,col = country))


## ------------------------------------------------------------------------
p <- p+geom_point() 


## --------------------------------------------------------------
p


## ------------------------------------------------------------------------
p0 <- gap %>% 
  ggplot(aes(
   x = year, 
   y = lifeExp, 
   size = pop))
p0 <- p0 + geom_point(
    show.legend = 
    FALSE,
    col ="red") 


## --------------------------------------------------------------
p0


## ------------------------------------------------------------------------
gap %>% 
  group_by(year) %>% 
  summarise(AVG = mean(gdpPercap)) 


## ------------------------------------------------------------------------
p <- gap %>% 
  ggplot(aes(year, 
    gdpPercap)) 
p <- p +
  geom_bar(stat = 
    "summary",
    fun.y = "mean")


## --------------------------------------------------------------
p


## --------------------------------------------------------------
gap_avg <- gap %>% 
  group_by(year) %>% 
  summarise(AVG = 
    mean(gdpPercap)) 


## --------------------------------------------------------------
gap_avg


## ------------------------------------------------------------------------
p <- gap_avg %>% 
  ggplot(
   aes(year, AVG)) 
p <- p +
  geom_bar(
  stat ="identity")


## --------------------------------------------------------------
p


## --------------------------------------------------------------
p <- gap %>% 
  ggplot(aes(year, 
    gdpPercap))


## ------------------------------------------------------------------------
p <- p +
stat_summary(
  geom = "bar",
  fun.y = "mean") +
stat_summary(
  geom = "errorbar",
  fun.data = 
    "mean_se")


## --------------------------------------------------------------
p


## ------------------------------------------------------------------------
p <- doc %>% 
  ggplot(aes(POS1,
             FREQ,
        fill = Doc))
p <- p +
 geom_bar(
  stat="identity")


## --------------------------------------------------------------
p


## ------------------------------------------------------------------------
china <- gap %>% 
 filter(
  country == "China") 
p <- china %>% 
  ggplot(
    aes(lifeExp))+
    geom_histogram()


## --------------------------------------------------------------
p


## ------------------------------------------------------------------------
p <- china %>% 
  ggplot(
    aes(lifeExp)) +
  geom_histogram(
    bins = 6)


## --------------------------------------------------------------
p


## ------------------------------------------------------------------------
p <- china %>% 
  ggplot(
    aes(lifeExp,
    y=..density..))+
  geom_histogram(
    bins = 6)


## ------------------------------------------------------------------------
p + geom_density()


## ------------------------------------------------------------------------
p <- gap %>% 
  ggplot(aes(year, 
    lifeExp,
    group=country))
p <- p + geom_line()


## --------------------------------------------------------------
p


## ------------------------------------------------------------------------
p <- gap %>% 
  ggplot(
   aes(x=country, 
       y=gdpPercap))
p <- p + 
     geom_boxplot()



## --------------------------------------------------------------
p


## ------------------------------------------------------------------------
p_f <- p + 
  facet_grid(
    . ~ country)


## --------------------------------------------------------------
p_f


## --------------------------------------------------------------
## p +
##   facet_wrap(
##     ~ country)


## --------------------------------------------------------------
p + 
  facet_wrap(
    ~ country)


## ----, ----------------------------------------------
## p2 <- gap %>%
##   ggplot(aes(year,
##     lifeExp,
##     group=country)) + geom_point()


## ------------------------------------------------------------------------
p + facet_grid(
  country~year)


## ------------------------------------------------------------------------
p + facet_wrap(
  country~year)


## ------------------------------------------------------------------------
p_f <- p + 
  facet_grid(. 
    ~ country,
    scales = "free")


## --------------------------------------------------------------
p_f


## ------------------------------------------------------------------------
p_f <- p + 
  facet_grid(. 
    ~ country)
# "free"を削除


## --------------------------------------------------------------
p_f


## ------------------------------------------------------------------------
p <- p +
  theme_classic()


## --------------------------------------------------------------
p 

